version: 0.2

phases:
  install:
    runtime-versions:
      java: corretto8
  pre_build:
    commands:
      # - env
      # Exporting STS REGIONAL ENDPOINT -   THIS IS A MANDATORY STEP FOR SETTING UP CREDS
      - export AWS_STS_REGIONAL_ENDPOINTS=regional

      # Setting up Credentials
      - CREDS=$(aws sts assume-role --role-arn arn:aws:iam::$RPL_TARGET_ACCOUNT_ID:role/service-role/deployer-supersonic-telemetry-service-role --role-session-name deployer)
      - export AWS_ACCESS_KEY_ID=$(echo $CREDS | jq -r .Credentials.AccessKeyId)
      - export AWS_SECRET_ACCESS_KEY=$(echo $CREDS | jq -r .Credentials.SecretAccessKey)
      - export AWS_SESSION_TOKEN=$(echo $CREDS | jq -r .Credentials.SessionToken)
  build:
    commands:
      # Deploying CloudFormation   in the target account
      - BUCKET_NAME=supersonic-telemetry-integration-deploy
      - aws s3api get-bucket-location --bucket ${BUCKET_NAME} || aws s3 mb s3://${BUCKET_NAME}
      - aws s3api put-bucket-tagging --bucket ${BUCKET_NAME} --tagging 'TagSet=[{Key=RoleType,Value=recptd}]'
      - aws s3api put-bucket-versioning --bucket ${BUCKET_NAME} --versioning-configuration Status=Enabled
      - aws s3api put-public-access-block --bucket ${BUCKET_NAME} --public-access-block-configuration 'BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true'
      - aws s3api put-bucket-encryption --bucket ${BUCKET_NAME} --server-side-encryption-configuration '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"}}]}'
      - aws s3api put-object --bucket ${BUCKET_NAME} --key SeikoLambda --body ./build/distributions/QueryExecuter.zip
      - sam package --template-file template.yml --s3-bucket ${BUCKET_NAME} --output-template-file outputtemplate.yaml
      - sam deploy --template-file outputtemplate.yaml --stack-name supersonic-seiko-service --capabilities CAPABILITY_IAM --tags RoleType=recptd --no-fail-on-empty-changeset